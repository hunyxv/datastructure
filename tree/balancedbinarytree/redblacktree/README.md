## 红黑树

### 红黑树的定义

红黑树是一种自平衡二叉查找树，是在计算机科学中用到的一种数据结构，典型的用途是实现关联数组。它是在1972年由鲁道夫·贝尔发明的，称之为"对称二叉B树"，它现代的名字是在 Leo J. Guibas 和 Robert Sedgewick 于1978年写的一篇论文中获得的。它是复杂的，但它的操作有着良好的最坏情况运行时间，并且在实践中是高效的: **它可以在O(logn)时间内做查找，插入和删除，这里的n是树中元素的数目**。

红黑树和AVL树一样都对插入时间、删除时间和查找时间提供了最好可能的最坏情况担保。这不只是使它们在时间敏感的应用如实时应用（real time application）中有价值，而且使它们有在提供最坏情况担保的其他数据结构中作为建造板块的价值；例如，在计算几何中使用的很多数据结构都可以基于红黑树。此外，红黑树还是2-3-4树的一种等同，它们的思想是一样的，只不过红黑树是2-3-4树用二叉树的形式表示的。

红黑树性质：
- 每个节点或者是黑色，或者是红色。
- 根节点是黑色。
- 每个叶子节点（空叶子节点）是黑色。
- 如果一个节点是红色的，则它的子节点必须是黑色的
- 任意一个节点到叶子节点（可到达的节点），经过的黑色节点数量是一样的。

2-3 树与红黑树是同一种树，只不过红黑树是 2-3 树的一种只含 2 节点的表现形式。(注： 红黑树并不是只有这一种实现方式）。可以把 2-3 树的三节点看作二分搜索树中的两个节点 合作构成的一个节点，二其中小的一方就是红节点。

![2->黑色，3左红右黑](https://i.loli.net/2021/01/13/DF7vgAEaSTmHIez.png)

23树转红黑树：

![23->红黑](https://i.loli.net/2021/01/13/CrvXjAWtf93L6xG.jpg)

一个完整的红黑树，符合上面五条性质：

![redblacktree.jpeg](https://i.loli.net/2021/01/13/IB3seLQDc47F5nV.jpg)

**重点：**
**需要做变色的情况：**
- 新插入的节点是根节点，根据性质2,颜色变成黑色，相当简单。
- 如果它的父节点也是红色，违反了性质4，此时如果发现叔节点也是红色，那么将父与叔节点标记为黑色，祖节点为红色，然后把祖节点当作新插入的节点递归重复这一判断，直到根节点，将根节点颜色设置为黑色。

**需要做变色与旋转的情况：**
- 当叔节点是黑色，需要做旋转，这是此文的重点。
- 我们一般会使用左左，右右，左右，右左来表示插入节点与父节点所在的位置，然后根据这些位置来做旋转的应用。文字通常是难记的，放弃文字描述，而使用符号以及图像来记忆：
 - 左左：/ 一根斜线(此时最好用手比划一下)，顶点表示祖节点，中间点表示父节点，底点表示插入节点
 - 右右: \ 一根反斜线，表示同上
 - 左右：< 一个小于号，顶点表示祖节点，中间尖点表示父节点，底点表示插入节点
 - 右左：> 一个大于号，表示同上

**红黑树是一棵平衡树，保持结构平衡是其存在的根本意义，而一根”斜线“或者“反斜线”，一个“小于号”或“大于号”，以底部为支持是无法保持平衡的，如果让其转变成一个三角型:⋀，那便是平衡的。**

### 插入节点


红黑树总是通过旋转和变色达到自平衡。那么在插入新节点时如何保持红黑树性质，怎么旋转？怎么变色？具体情景又不同变法（8 种场景）：

![readblacktree-insert.jpg](https://i.loli.net/2021/01/13/S8jbCesAVkNfBu4.jpg)

关于 I、S、P、PP 节点：

![ppp.jpg](https://i.loli.net/2021/01/13/bROovBaLg7ApVd8.jpg)

### 删除节点

删除操作的所有情景，如下图所示：

![delete.jpg](https://i.loli.net/2021/01/13/dczBRPYo15VvpFN.jpg)

![xxxxx.jpg](https://i.loli.net/2021/01/14/ptTWobyIcVxz4U5.jpg)

#### 删除情景1：替换结点是红色结点
我们把替换结点换到了删除结点的位置时，由于替换结点是红色，删除也了不会影响红黑树的平衡，只要把替换结点的颜色设为删除的结点的颜色即可重新平衡。

处理：
- 颜色变为删除结点的颜色

#### 删除情景2：替换结点是黑结点
当替换结点是黑色时，我们就不得不进行自平衡处理了。我们必须还得考虑替换结点是其父结点的左子结点还是右子结点，来做不同的旋转操作，使树重新平衡。

##### 删除情景2.1：替换结点是其父结点的左子结点
###### 删除情景2.1.1：替换结点的兄弟结点是红结点
若兄弟结点是红结点，那么根据性质4，兄弟结点的父结点和子结点肯定为黑色，不会有其他子情景，我们按下图处理，得到删除情景2.1.2.3（后续讲解，这里先记住，此时R仍然是替代结点，它的新的兄弟结点SL和兄弟结点的子结点都是黑色）。

处理：
- 将S设为黑色
- 将P设为红色
- 对P进行左旋，得到情景2.1.2.3
- 进行情景2.1.2.3的处理

![rb1.jpg](https://i.loli.net/2021/01/15/dTQsRyhLclB8SzD.jpg)

###### 删除情景2.1.2：替换结点的兄弟结点是黑结点
当兄弟结点为黑时，其父结点和子结点的具体颜色也无法确定（如果也不考虑自底向上的情况，子结点非红即为叶子结点Nil，Nil结点为黑结点），此时又得考虑多种子情景。

###### 删除情景2.1.2.1：替换结点的兄弟结点的右子结点是红结点，左子结点任意颜色
即将删除的左子树的一个黑色结点，显然左子树的黑色结点少1了，然而右子树又又红色结点，那么我们直接向右子树“借”个红结点来补充黑结点就好啦，此时肯定需要用旋转处理了。如图22所示。

处理：
- 将S的颜色设为P的颜色
- 将P设为黑色
- 将SR设为黑色
- 对P进行左旋

![rb2.jpg](https://i.loli.net/2021/01/15/N4hGyUQ1nRevHcu.jpg)

平衡后的图怎么不满足红黑树的性质？前文提醒过，R是即将替换的，它还参与树的自平衡，平衡后再替换到删除结点的位置，所以R最终可以看作是删除的。另外图2.1.2.1是考虑到第一次替换和自底向上处理的情况，如果只考虑第一次替换的情况，根据红黑树性质，SL肯定是红色或为Nil，所以最终结果树是平衡的。如果是自底向上处理的情况，同样，每棵子树都保持平衡状态，最终整棵树肯定是平衡的。后续的情景同理，不做过多说明了。

###### 删除情景2.1.2.2：替换结点的兄弟结点的右子结点为黑结点，左子结点为红结点
兄弟结点所在的子树有红结点，我们总是可以向兄弟子树借个红结点过来，显然该情景可以转换为情景2.1.2.1。图如23所示。

处理：
- 将S设为红色
- 将SL设为黑色
- 对S进行右旋，得到情景2.1.2.1
- 进行情景2.1.2.1的处理

![rb3.jpg](https://i.loli.net/2021/01/15/2zIYxKkjidDPv5M.jpg)

###### 删除情景2.1.2.3：替换结点的兄弟结点的子结点都为黑结点
好了，此次兄弟子树都没红结点“借”了，兄弟帮忙不了，找父母呗，这种情景我们把兄弟结点设为红色，再把父结点当作替代结点，自底向上处理，去找父结点的兄弟结点去“借”。但为什么需要把兄弟结点设为红色呢？显然是为了在P所在的子树中保证平衡（R即将删除，少了一个黑色结点，子树也需要少一个），后续的平衡工作交给父辈们考虑了，还是那句，当每棵子树都保持平衡时，最终整棵总是平衡的。

处理：
- 将S设为红色
- 把P作为新的替换结点
- 重新进行删除结点情景处理

![rb4.jpg](https://i.loli.net/2021/01/15/eGbIViEKJulRzox.jpg)

#### 删除情景2.2：替换结点是其父结点的右子结点
好啦，右边的操作也是方向相反，不做过多说明了，相信理解了删除情景2.1后，肯定可以理解2.2。

##### 删除情景2.2.1：替换结点的兄弟结点是红结点
处理：
- 将S设为黑色
- 将P设为红色
- 对P进行右旋，得到情景2.2.2.3
- 进行情景2.2.2.3的处理

![rb5.jpg](https://i.loli.net/2021/01/15/jvNGQKUVy19hFJw.jpg)

##### 删除情景2.2.2：替换结点的兄弟结点是黑结点
###### 删除情景2.2.2.1：替换结点的兄弟结点的左子结点是红结点，右子结点任意颜色
处理：
- 将S的颜色设为P的颜色
- 将P设为黑色
- 将SL设为黑色
- 对P进行右旋

![rb6.jpg](https://i.loli.net/2021/01/15/lYQphSroCxWbV23.jpg)

###### 删除情景2.2.2.2：替换结点的兄弟结点的左子结点为黑结点，右子结点为红结点
处理：
- 将S设为红色
- 将SR设为黑色
- 对S进行左旋，得到情景2.2.2.1
- 进行情景2.2.2.1的处理

![rb7.jpg](https://i.loli.net/2021/01/15/BouI24cmVHrNlKa.jpg)

###### 删除情景2.2.2.3：替换结点的兄弟结点的子结点都为黑结点
处理：
- 将S设为红色
- 把P作为新的替换结点
- 重新进行删除结点情景处理

![rb8.jpg](https://i.loli.net/2021/01/15/dUS1kpsILDWlJ6q.jpg)

综上，红黑树删除后自平衡的处理可以总结为：

自己能搞定的自消化（情景1）
自己不能搞定的叫兄弟帮忙（除了情景1、情景2.1.2.3和情景2.2.2.3）
兄弟都帮忙不了的，通过父母，找远房亲戚（情景2.1.2.3和情景2.2.2.3）


#### 使用场景
许多需要进行频繁删插操作的场景都使用来红黑树，比如：
- [epoll](https://zh.wikipedia.org/wiki/Epoll) IO 多路复用的核心数据结构就是红黑树
- linux 中进程的调度（[Completely Fair Scheduler](https://zh.wikipedia.org/wiki/%E5%AE%8C%E5%85%A8%E5%85%AC%E5%B9%B3%E6%8E%92%E7%A8%8B%E5%99%A8)）也是使用的红黑树。